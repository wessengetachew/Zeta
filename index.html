
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primitive Lattice Directions & Modular Circles</title>
    <style>
        :root {
            --bg-deep: #0a0e1a;
            --bg-card: #141829;
            --bg-panel: #1a1f35;
            --gold: #FFD700;
            --gold-dim: #B8960A;
            --cyan: #00FFFF;
            --cyan-dim: #008B8B;
            --text-primary: #E8E8E8;
            --text-secondary: #A0A0A0;
            --border: #2a3150;
            --accent-purple: #9F7AEA;
            --accent-green: #48BB78;
        }

        [data-theme="light"] {
            --bg-deep: #f7fafc;
            --bg-card: #ffffff;
            --bg-panel: #edf2f7;
            --gold: #d69e00;
            --gold-dim: #b8860b;
            --cyan: #0891b2;
            --cyan-dim: #0e7490;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --border: #cbd5e0;
            --accent-purple: #7c3aed;
            --accent-green: #059669;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--gold), var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.2em;
            font-style: italic;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .theme-toggle:hover {
            border-color: var(--gold);
            transform: translateY(-2px);
        }

        .controls-panel {
            background: var(--bg-panel);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--gold);
            margin-bottom: 15px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.95em;
        }

        input[type="number"], select {
            width: 100%;
            padding: 10px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--cyan);
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--gold);
            cursor: pointer;
            border-radius: 50%;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding: 8px;
            background: var(--bg-card);
            border-radius: 6px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--cyan);
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }

        .canvas-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }

        .canvas-panel {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .canvas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .canvas-title {
            font-size: 1.4em;
            font-weight: 600;
            color: var(--gold);
        }

        .independent-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .canvas-controls {
            background: var(--bg-panel);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }

        canvas {
            display: block;
            margin: 0 auto;
            background: var(--bg-deep);
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: crosshair;
        }

        .legend-panel {
            background: var(--bg-panel);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }

        .legend-title {
            font-weight: 600;
            color: var(--cyan);
            margin-bottom: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 2px solid var(--border);
        }

        button {
            background: linear-gradient(135deg, var(--gold), var(--gold-dim));
            color: var(--bg-deep);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
        }

        button.secondary {
            background: linear-gradient(135deg, var(--cyan), var(--cyan-dim));
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .export-panel {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .slider-value {
            margin-left: 10px;
            color: var(--gold);
            font-weight: 600;
            font-family: monospace;
        }

        .control-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        @media (max-width: 1200px) {
            .canvas-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()">Toggle Theme</button>

    <div class="container">
        <div class="header">
            <h1>Primitive Lattice Directions & Modular Circles</h1>
            <div class="subtitle">GCD-Visibility and Gaussian Integers</div>
        </div>

        <div class="controls-panel">
            <div class="section-title">âš™ Global Controls</div>
            
            <div class="control-group">
                <label>Modulus m: <span class="slider-value" id="modulusValue">8</span></label>
                <input type="range" id="modulus" min="2" max="100" value="8" oninput="updateModulus()">
                <div class="preset-buttons">
                    <button onclick="setMod(6)">m=6</button>
                    <button onclick="setMod(12)">m=12</button>
                    <button onclick="setMod(17)">m=17</button>
                    <button onclick="setMod(60)">m=60</button>
                </div>
            </div>

            <div class="control-group">
                <label>Lattice Range: <span class="slider-value" id="rangeValue">15</span></label>
                <input type="range" id="latticeRange" min="5" max="50" value="15" oninput="updateRange()">
            </div>
        </div>

        <div class="canvas-grid">
            <!-- Canvas 1 -->
            <div class="canvas-panel">
                <div class="canvas-header">
                    <div class="canvas-title">Canvas 1: Modular Circle</div>
                    <div class="independent-toggle">
                        <input type="checkbox" id="c1Ind" onchange="updateCanvas1()">
                        <label for="c1Ind">Independent</label>
                    </div>
                </div>

                <div id="c1IndControls" style="display:none;">
                    <div class="canvas-controls">
                        <label>Canvas 1 Modulus: <span class="slider-value" id="c1ModVal">8</span></label>
                        <input type="range" id="c1Mod" min="2" max="100" value="8" oninput="updateCanvas1()">
                    </div>
                </div>

                <div class="canvas-controls">
                    <div class="checkbox-group">
                        <input type="checkbox" id="c1ShowCircle" checked onchange="updateCanvas1()">
                        <label for="c1ShowCircle">Show Circle</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="c1ShowPoints" checked onchange="updateCanvas1()">
                        <label for="c1ShowPoints">Show Points</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="c1ShowLabels" checked onchange="updateCanvas1()">
                        <label for="c1ShowLabels">Show Labels</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="c1ShowPoly" checked onchange="updateCanvas1()">
                        <label for="c1ShowPoly">Show Polygon</label>
                    </div>
                    <div class="control-group">
                        <label>Color Scheme:</label>
                        <select id="c1Color" onchange="updateCanvas1()">
                            <option value="default">Default</option>
                            <option value="rainbow">Rainbow</option>
                            <option value="heatmap">Heatmap</option>
                            <option value="monochrome">Monochrome</option>
                        </select>
                    </div>
                </div>

                <canvas id="canvas1" width="700" height="700"></canvas>

                <div class="legend-panel">
                    <div class="legend-title">Legend</div>
                    <div id="legend1"></div>
                </div>
            </div>

            <!-- Canvas 2 -->
            <div class="canvas-panel">
                <div class="canvas-header">
                    <div class="canvas-title">Canvas 2: Lattice Directions</div>
                    <div class="independent-toggle">
                        <input type="checkbox" id="c2Ind" onchange="updateCanvas2()">
                        <label for="c2Ind">Independent</label>
                    </div>
                </div>

                <div id="c2IndControls" style="display:none;">
                    <div class="canvas-controls">
                        <div class="control-row">
                            <div>
                                <label>Canvas 2 Modulus: <span class="slider-value" id="c2ModVal">8</span></label>
                                <input type="range" id="c2Mod" min="2" max="100" value="8" oninput="updateCanvas2()">
                            </div>
                            <div>
                                <label>Canvas 2 Range: <span class="slider-value" id="c2RangeVal">15</span></label>
                                <input type="range" id="c2Range" min="5" max="50" value="15" oninput="updateCanvas2()">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="canvas-controls">
                    <div class="checkbox-group">
                        <input type="checkbox" id="c2Invert" onchange="toggleInvert()">
                        <label for="c2Invert">Invert to Concentric Rings</label>
                    </div>

                    <div id="invertOptions" style="display:none;">
                        <div class="control-group">
                            <label>Ring Mode:</label>
                            <select id="ringMode" onchange="updateCanvas2()">
                                <option value="standard">Standard (small inner)</option>
                                <option value="inverse">Inverse (small outer)</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Max Modulus (Rings): <span class="slider-value" id="maxModVal">20</span></label>
                            <input type="range" id="maxMod" min="5" max="100" value="20" oninput="updateMaxMod()">
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Display Mode:</label>
                        <select id="c2Display" onchange="updateCanvas2()">
                            <option value="all">All Primitive</option>
                            <option value="primes">Prime Norms</option>
                            <option value="specific">Specific Norm</option>
                        </select>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="c2ShowLabels" checked onchange="updateCanvas2()">
                        <label for="c2ShowLabels">Show Labels</label>
                    </div>

                    <div class="control-group">
                        <label>Zoom: <span class="slider-value" id="zoomVal">100</span>%</label>
                        <input type="range" id="zoom" min="50" max="300" value="100" oninput="updateZoom()">
                    </div>

                    <div class="control-group">
                        <label>Color Scheme:</label>
                        <select id="c2Color" onchange="updateCanvas2()">
                            <option value="default">Default</option>
                            <option value="rainbow">Rainbow</option>
                            <option value="gcdBased">GCD-Based</option>
                            <option value="normBased">Norm-Based</option>
                        </select>
                    </div>
                </div>

                <canvas id="canvas2" width="700" height="700"></canvas>

                <div class="legend-panel">
                    <div class="legend-title">Legend</div>
                    <div id="legend2"></div>
                </div>
            </div>
        </div>

        <div class="export-panel">
            <div class="section-title">ðŸ’¾ Export</div>
            <div class="export-grid">
                <button onclick="exportPNG('canvas1')">Export Canvas 1</button>
                <button onclick="exportPNG('canvas2')">Export Canvas 2</button>
                <button class="secondary" onclick="exportCSV('canvas1')">CSV Canvas 1</button>
                <button class="secondary" onclick="exportCSV('canvas2')">CSV Canvas 2</button>
            </div>
        </div>
    </div>

    <script>
        let theme = 'dark';
        let c2Inverted = false;
        let c2Zoom = 1.0;
        let legendData1 = [];
        let legendData2 = [];

        function gcd(a, b) {
            a = Math.abs(a);
            b = Math.abs(b);
            while (b) {
                let t = b;
                b = a % b;
                a = t;
            }
            return a;
        }

        function isPrime(n) {
            if (n < 2) return false;
            if (n === 2) return true;
            if (n % 2 === 0) return false;
            for (let i = 3; i * i <= n; i += 2) {
                if (n % i === 0) return false;
            }
            return true;
        }

        function getResidues(m) {
            return Array.from({length: m}, (_, i) => i).filter(r => gcd(r, m) === 1);
        }

        function getLatticePoints(range) {
            const pts = [];
            for (let a = -range; a <= range; a++) {
                for (let b = -range; b <= range; b++) {
                    if (a === 0 && b === 0) continue;
                    if (gcd(a, b) === 1) {
                        const norm = a * a + b * b;
                        pts.push({a, b, norm, isPrime: isPrime(norm)});
                    }
                }
            }
            return pts;
        }

        function getColor(scheme, val, max, isReduced) {
            if (scheme === 'rainbow') {
                const h = (val / max) * 360;
                return `hsl(${h}, 80%, 60%)`;
            } else if (scheme === 'heatmap') {
                const r = Math.floor((val / max) * 255);
                const b = 255 - r;
                return `rgb(${r}, 0, ${b})`;
            } else if (scheme === 'monochrome') {
                return theme === 'dark' ? '#FFD700' : '#d69e00';
            } else {
                return isReduced ? 
                    (theme === 'dark' ? '#00FFFF' : '#0891b2') : 
                    (theme === 'dark' ? '#e74c3c' : '#dc2626');
            }
        }

        function toggleTheme() {
            theme = theme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', theme);
            updateCanvas1();
            updateCanvas2();
        }

        function updateModulus() {
            const m = document.getElementById('modulus').value;
            document.getElementById('modulusValue').textContent = m;
            if (!document.getElementById('c1Ind').checked) {
                document.getElementById('c1Mod').value = m;
                document.getElementById('c1ModVal').textContent = m;
            }
            if (!document.getElementById('c2Ind').checked) {
                document.getElementById('c2Mod').value = m;
                document.getElementById('c2ModVal').textContent = m;
            }
            updateCanvas1();
            updateCanvas2();
        }

        function updateRange() {
            const r = document.getElementById('latticeRange').value;
            document.getElementById('rangeValue').textContent = r;
            if (!document.getElementById('c2Ind').checked) {
                document.getElementById('c2Range').value = r;
                document.getElementById('c2RangeVal').textContent = r;
            }
            updateCanvas2();
        }

        function setMod(m) {
            document.getElementById('modulus').value = m;
            updateModulus();
        }

        function toggleInvert() {
            c2Inverted = document.getElementById('c2Invert').checked;
            document.getElementById('invertOptions').style.display = c2Inverted ? 'block' : 'none';
            updateCanvas2();
        }

        function updateMaxMod() {
            const m = document.getElementById('maxMod').value;
            document.getElementById('maxModVal').textContent = m;
            updateCanvas2();
        }

        function updateZoom() {
            c2Zoom = document.getElementById('zoom').value / 100;
            document.getElementById('zoomVal').textContent = Math.round(c2Zoom * 100);
            updateCanvas2();
        }

        function updateCanvas1() {
            const isInd = document.getElementById('c1Ind').checked;
            document.getElementById('c1IndControls').style.display = isInd ? 'block' : 'none';
            
            const m = isInd ? 
                parseInt(document.getElementById('c1Mod').value) :
                parseInt(document.getElementById('modulus').value);
            
            if (isInd) document.getElementById('c1ModVal').textContent = m;
            
            const canvas = document.getElementById('canvas1');
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            const cx = w/2, cy = h/2;
            const r = Math.min(w, h) * 0.35;
            
            const showCircle = document.getElementById('c1ShowCircle').checked;
            const showPoints = document.getElementById('c1ShowPoints').checked;
            const showLabels = document.getElementById('c1ShowLabels').checked;
            const showPoly = document.getElementById('c1ShowPoly').checked;
            const colorScheme = document.getElementById('c1Color').value;
            
            ctx.clearRect(0, 0, w, h);
            
            if (showCircle) {
                ctx.beginPath();
                ctx.arc(cx, cy, r, 0, 2 * Math.PI);
                ctx.strokeStyle = theme === 'dark' ? '#FFD700' : '#d69e00';
                ctx.lineWidth = 3;
                ctx.stroke();
            }
            
            ctx.strokeStyle = theme === 'dark' ? '#00FFFF' : '#0891b2';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(cx - r, cy);
            ctx.lineTo(cx + r, cy);
            ctx.moveTo(cx, cy - r);
            ctx.lineTo(cx, cy + r);
            ctx.stroke();
            
            const residues = getResidues(m);
            legendData1 = [];
            
            if (showPoints) {
                for (let i = 0; i < m; i++) {
                    const isRed = residues.includes(i);
                    const ang = (2 * Math.PI * i / m) - Math.PI / 2;
                    const x = cx + r * Math.cos(ang);
                    const y = cy + r * Math.sin(ang);
                    
                    ctx.beginPath();
                    ctx.arc(x, y, isRed ? 7 : 5, 0, 2 * Math.PI);
                    const col = getColor(colorScheme, i, m, isRed);
                    ctx.fillStyle = col;
                    ctx.fill();
                    ctx.strokeStyle = theme === 'dark' ? '#E8E8E8' : '#1a202c';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    if (showLabels) {
                        ctx.fillStyle = theme === 'dark' ? '#E8E8E8' : '#1a202c';
                        ctx.font = '12px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText(i.toString(), cx + (r + 25) * Math.cos(ang), cy + (r + 25) * Math.sin(ang));
                    }
                }
            }
            
            if (showPoly && residues.length > 0) {
                ctx.strokeStyle = theme === 'dark' ? '#9F7AEA' : '#7c3aed';
                ctx.lineWidth = 3;
                ctx.beginPath();
                residues.forEach((ri, i) => {
                    const ang = (2 * Math.PI * ri / m) - Math.PI / 2;
                    const x = cx + r * Math.cos(ang);
                    const y = cy + r * Math.sin(ang);
                    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                });
                ctx.closePath();
                ctx.stroke();
            }
            
            legendData1 = [
                {color: getColor(colorScheme, 0, 1, true), label: `Reduced Residues (Ï†(${m})=${residues.length})`},
                {color: getColor(colorScheme, 0, 1, false), label: 'Non-coprime'},
                {color: theme === 'dark' ? '#9F7AEA' : '#7c3aed', label: 'Polygon'}
            ];
            
            updateLegend(1);
        }

        function updateCanvas2() {
            const isInd = document.getElementById('c2Ind').checked;
            document.getElementById('c2IndControls').style.display = isInd ? 'block' : 'none';
            
            const m = isInd ? 
                parseInt(document.getElementById('c2Mod').value) :
                parseInt(document.getElementById('modulus').value);
            
            const range = isInd ?
                parseInt(document.getElementById('c2Range').value) :
                parseInt(document.getElementById('latticeRange').value);
            
            if (isInd) {
                document.getElementById('c2ModVal').textContent = m;
                document.getElementById('c2RangeVal').textContent = range;
            }
            
            if (c2Inverted) {
                drawRings();
            } else {
                drawLattice(m, range);
            }
        }

        function drawLattice(m, range) {
            const canvas = document.getElementById('canvas2');
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            const cx = w/2, cy = h/2;
            const scale = (Math.min(w, h) / (2 * range + 4)) * c2Zoom;
            
            const showLabels = document.getElementById('c2ShowLabels').checked;
            const displayMode = document.getElementById('c2Display').value;
            const colorScheme = document.getElementById('c2Color').value;
            
            ctx.clearRect(0, 0, w, h);
            
            ctx.strokeStyle = theme === 'dark' ? '#00FFFF' : '#0891b2';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, cy);
            ctx.lineTo(w, cy);
            ctx.moveTo(cx, 0);
            ctx.lineTo(cx, h);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.arc(cx, cy, scale, 0, 2 * Math.PI);
            ctx.strokeStyle = theme === 'dark' ? '#FFD700' : '#d69e00';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.setLineDash([]);
            
            let pts = getLatticePoints(range);
            if (displayMode === 'primes') pts = pts.filter(p => p.isPrime);
            if (displayMode === 'specific') pts = pts.filter(p => p.norm === m);
            
            pts.forEach(p => {
                const x = cx + p.a * scale;
                const y = cy - p.b * scale;
                
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.lineTo(x, y);
                ctx.strokeStyle = p.isPrime ? 
                    (theme === 'dark' ? '#FFD700' : '#d69e00') :
                    (theme === 'dark' ? '#48BB78' : '#059669');
                ctx.lineWidth = 1.5;
                ctx.globalAlpha = 0.4;
                ctx.stroke();
                ctx.globalAlpha = 1;
                
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, 2 * Math.PI);
                ctx.fillStyle = p.isPrime ? 
                    (theme === 'dark' ? '#FFD700' : '#d69e00') :
                    (theme === 'dark' ? '#48BB78' : '#059669');
                ctx.fill();
                ctx.strokeStyle = theme === 'dark' ? '#E8E8E8' : '#1a202c';
                ctx.lineWidth = 1.5;
                ctx.stroke();
                
                if (showLabels && Math.abs(p.a) <= 5 && Math.abs(p.b) <= 5) {
                    ctx.fillStyle = theme === 'dark' ? '#E8E8E8' : '#1a202c';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(`(${p.a},${p.b})`, x, y - 10);
                }
                
                const ang = Math.atan2(p.b, p.a);
                const ux = cx + scale * Math.cos(ang);
                const uy = cy - scale * Math.sin(ang);
                ctx.beginPath();
                ctx.arc(ux, uy, 6, 0, 2 * Math.PI);
                ctx.fillStyle = theme === 'dark' ? '#00FFFF' : '#0891b2';
                ctx.fill();
                ctx.strokeStyle = theme === 'dark' ? '#E8E8E8' : '#1a202c';
                ctx.lineWidth = 2;
                ctx.stroke();
            });
            
            legendData2 = [
                {color: theme === 'dark' ? '#48BB78' : '#059669', label: 'Primitive Vectors'},
                {color: theme === 'dark' ? '#FFD700' : '#d69e00', label: 'Prime Norms'},
                {color: theme === 'dark' ? '#00FFFF' : '#0891b2', label: 'Unit Circle Projection'}
            ];
            
            updateLegend(2);
        }

        function drawRings() {
            const maxMod = parseInt(document.getElementById('maxMod').value);
            const ringMode = document.getElementById('ringMode').value;
            const showLabels = document.getElementById('c2ShowLabels').checked;
            const colorScheme = document.getElementById('c2Color').value;
            
            const canvas = document.getElementById('canvas2');
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            const cx = w/2, cy = h/2;
            const maxR = Math.min(w, h) * 0.4 * c2Zoom;
            const spacing = maxR / maxMod;
            
            ctx.clearRect(0, 0, w, h);
            
            ctx.strokeStyle = theme === 'dark' ? '#00FFFF' : '#0891b2';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, cy);
            ctx.lineTo(w, cy);
            ctx.moveTo(cx, 0);
            ctx.lineTo(cx, h);
            ctx.stroke();
            
            for (let m = 2; m <= maxMod; m++) {
                const r = ringMode === 'standard' ? m * spacing : (maxMod - m + 2) * spacing;
                
                ctx.beginPath();
                ctx.arc(cx, cy, r, 0, 2 * Math.PI);
                ctx.strokeStyle = theme === 'dark' ? '#2a3150' : '#cbd5e0';
                ctx.lineWidth = 1;
                ctx.setLineDash([2, 2]);
                ctx.stroke();
                ctx.setLineDash([]);
                
                const residues = getResidues(m);
                
                for (let ri = 0; ri < m; ri++) {
                    const isRed = residues.includes(ri);
                    const ang = (2 * Math.PI * ri / m) - Math.PI / 2;
                    const x = cx + r * Math.cos(ang);
                    const y = cy + r * Math.sin(ang);
                    
                    ctx.beginPath();
                    ctx.arc(x, y, isRed ? 6 : 4, 0, 2 * Math.PI);
                    ctx.fillStyle = getColor(colorScheme, ri, m, isRed);
                    ctx.fill();
                    ctx.strokeStyle = theme === 'dark' ? '#E8E8E8' : '#1a202c';
                    ctx.lineWidth = 1.5;
                    ctx.stroke();
                    
                    if (showLabels && m <= 15) {
                        ctx.fillStyle = theme === 'dark' ? '#E8E8E8' : '#1a202c';
                        ctx.font = '9px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText(`${ri}/${m}`, x, y - 8);
                    }
                }
                
                if (m <= 15) {
                    ctx.fillStyle = theme === 'dark' ? '#FFD700' : '#d69e00';
                    ctx.font = 'bold 11px sans-serif';
                    ctx.fillText(`m=${m}`, cx + r + 5, cy);
                }
            }
            
            legendData2 = [
                {color: getColor(colorScheme, 0, 1, true), label: 'Reduced Residues'},
                {color: getColor(colorScheme, 0, 1, false), label: 'Non-coprime'}
            ];
            
            updateLegend(2);
        }

        function updateLegend(canvasNum) {
            const legend = document.getElementById(`legend${canvasNum}`);
            const data = canvasNum === 1 ? legendData1 : legendData2;
            
            legend.innerHTML = data.map(item => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${item.color};"></div>
                    <span>${item.label}</span>
                </div>
            `).join('');
        }

        function exportPNG(canvasId) {
            const canvas = document.getElementById(canvasId);
            const canvasNum = canvasId === 'canvas1' ? 1 : 2;
            const title = canvasNum === 1 ? 'Canvas 1: Modular Circle' : 'Canvas 2: Lattice Directions';
            const legendData = canvasNum === 1 ? legendData1 : legendData2;
            
            const temp = document.createElement('canvas');
            const res = 3840; // 4K
            const pad = 200;
            const legH = 100 + legendData.length * 80;
            temp.width = res + pad * 2;
            temp.height = res + pad + legH;
            
            const ctx = temp.getContext('2d');
            ctx.fillStyle = theme === 'dark' ? '#0a0e1a' : '#ffffff';
            ctx.fillRect(0, 0, temp.width, temp.height);
            
            // Title
            ctx.fillStyle = theme === 'dark' ? '#FFD700' : '#d69e00';
            ctx.font = 'bold 70px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(title, temp.width / 2, pad / 2 + 30);
            
            // Canvas
            const scale = res / canvas.width;
            ctx.save();
            ctx.translate(pad, pad);
            ctx.scale(scale, scale);
            ctx.drawImage(canvas, 0, 0);
            ctx.restore();
            
            // Legend
            const legY = res + pad + 80;
            ctx.fillStyle = theme === 'dark' ? '#E8E8E8' : '#1a202c';
            ctx.font = 'bold 50px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Legend:', pad, legY);
            
            let yOff = legY + 80;
            legendData.forEach(item => {
                ctx.fillStyle = item.color;
                ctx.fillRect(pad + 20, yOff - 30, 50, 50);
                ctx.strokeStyle = theme === 'dark' ? '#E8E8E8' : '#1a202c';
                ctx.lineWidth = 3;
                ctx.strokeRect(pad + 20, yOff - 30, 50, 50);
                
                ctx.fillStyle = theme === 'dark' ? '#E8E8E8' : '#1a202c';
                ctx.font = '40px sans-serif';
                ctx.fillText(item.label, pad + 90, yOff);
                
                yOff += 80;
            });
            
            // Footer
            ctx.fillStyle = theme === 'dark' ? '#A0A0A0' : '#4a5568';
            ctx.font = '30px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Created by Wessen Getachew (@7dview)', temp.width / 2, temp.height - 50);
            
            const link = document.createElement('a');
            link.download = `${title.replace(/[^a-z0-9]/gi, '_')}.png`;
            link.href = temp.toDataURL('image/png');
            link.click();
        }

        function exportCSV(canvasId) {
            const canvasNum = canvasId === 'canvas1' ? 1 : 2;
            let csv = '';
            
            if (canvasNum === 1) {
                const isInd = document.getElementById('c1Ind').checked;
                const m = isInd ? 
                    parseInt(document.getElementById('c1Mod').value) :
                    parseInt(document.getElementById('modulus').value);
                
                csv = 'Modulus,Residue,IsReduced,GCD,Angle_rad,Angle_deg\n';
                for (let r = 0; r < m; r++) {
                    const isRed = gcd(r, m) === 1;
                    const ang = (2 * Math.PI * r / m);
                    csv += `${m},${r},${isRed},${gcd(r, m)},${ang.toFixed(10)},${(ang * 180 / Math.PI).toFixed(6)}\n`;
                }
            } else {
                const isInd = document.getElementById('c2Ind').checked;
                const range = isInd ?
                    parseInt(document.getElementById('c2Range').value) :
                    parseInt(document.getElementById('latticeRange').value);
                
                csv = 'a,b,Norm,GCD,IsPrime,Angle_rad,Angle_deg\n';
                const pts = getLatticePoints(range);
                pts.forEach(p => {
                    const ang = Math.atan2(p.b, p.a);
                    csv += `${p.a},${p.b},${p.norm},${gcd(p.a, p.b)},${p.isPrime},${ang.toFixed(10)},${(ang * 180 / Math.PI).toFixed(6)}\n`;
                });
            }
            
            const blob = new Blob([csv], {type: 'text/csv'});
            const link = document.createElement('a');
            link.download = `${canvasId}_data.csv`;
            link.href = URL.createObjectURL(blob);
            link.click();
        }

        updateCanvas1();
        updateCanvas2();
    </script>
</body>
</html>
